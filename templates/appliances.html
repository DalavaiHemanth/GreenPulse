{% extends "base.html" %}
{% block title %}Appliances - Green Pulse{% endblock %}
{% block content %}
  <div class="max-w-6xl mx-auto bg-white/10 backdrop-blur-md rounded-2xl p-8 shadow-lg mt-10">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold text-green-400">My Appliances</h1>
      <form method="post">
        <input type="hidden" name="toggle_inverter" value="1">
        <button type="submit" class="px-4 py-2 rounded-lg font-semibold {{ 'bg-yellow-400 text-gray-900' if inverter_mode else 'bg-gray-700 text-white' }} hover:bg-yellow-500 transition shadow-md">
          Inverter Mode: <strong>{{ 'ON' if inverter_mode else 'OFF' }}</strong>
        </button>
      </form>
    </div>

    <!-- Add and Search Section -->
    <div class="bg-gray-900/30 rounded-xl p-6 mb-8">
      <h2 class="text-xl font-semibold text-green-300 mb-4">Add a New Appliance</h2>
      <form method="post" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
        <input type="hidden" name="add_appliance" value="1">
        <div class="md:col-span-2">
          <label for="appliance-dropdown" class="block text-sm font-medium text-gray-300 mb-1">Appliance</label>
          <select name="name" id="appliance-dropdown" class="w-full px-3 py-2 rounded-lg bg-gray-800/60 border border-green-500 text-white focus:outline-none focus:ring-2 focus:ring-green-400">
            <option value="">-- Select or type custom --</option>
            {% for a in global_appliances %}
              <option value="{{ a['name'] }}">{{ a['name'] }}</option>
            {% endfor %}
            <option value="__custom__">Other (Custom)</option>
          </select>
        </div>
        <div>
          <label for="custom-appliance-input" class="block text-sm font-medium text-gray-300 mb-1">Custom Name</label>
          <input type="text" name="custom_name" id="custom-appliance-input" placeholder="e.g. Gaming PC" class="w-full px-3 py-2 rounded-lg bg-gray-800/60 border border-green-500 text-white placeholder-gray-400 hidden">
        </div>
        <div>
          <label for="count-input" class="block text-sm font-medium text-gray-300 mb-1">Count</label>
          <input type="number" name="count" id="count-input" min="1" value="1" required class="w-full px-3 py-2 rounded-lg bg-gray-800/60 border border-green-500 text-white">
        </div>
        <div>
          <label for="watts-input" class="block text-sm font-medium text-gray-300 mb-1">Watts</label>
          <input type="number" name="watts" id="watts-input" min="1" value="100" required class="w-full px-3 py-2 rounded-lg bg-gray-800/60 border border-green-500 text-white">
        </div>
        <div class="md:col-span-5 flex justify-end">
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg font-semibold text-white shadow-md transition">Add Appliance</button>
        </div>
      </form>
      <script>
        const dropdown = document.getElementById('appliance-dropdown');
        const customInput = document.getElementById('custom-appliance-input');
        dropdown.addEventListener('change', function() {
          if (this.value === '__custom__') {
            customInput.classList.remove('hidden');
            customInput.required = true;
            customInput.focus();
          } else {
            customInput.classList.add('hidden');
            customInput.required = false;
          }
        });
      </script>
    </div>

    <!-- Search Bar -->
    <div class="flex items-center mb-6">
        <form method="get" class="flex-grow">
            <div class="relative">
                <input type="text" name="search" value="{{ search }}" placeholder="Search your appliances..." class="w-full px-4 py-3 rounded-lg bg-gray-800/60 border border-green-500 text-white placeholder-green-400 focus:outline-none focus:ring-2 focus:ring-green-400">
                <button type="submit" class="absolute right-2 top-1/2 -translate-y-1/2 bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg font-semibold text-white">Search</button>
            </div>
        </form>
        {% if search %}
            <a href="{{ url_for('appliances') }}" class="ml-4 bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg font-semibold text-white">Clear Search</a>
        {% endif %}
    </div>

    <!-- Appliances Table -->
    <div class="overflow-x-auto rounded-lg shadow">
      <table class="min-w-full">
        <thead class="bg-green-800/50">
          <tr class="text-green-200 text-left text-sm uppercase">
            <th class="px-6 py-3 font-semibold">Appliance</th>
            <th class="px-6 py-3 font-semibold">Count</th>
            <th class="px-6 py-3 font-semibold">Watts</th>
            <th class="px-6 py-3 font-semibold text-center">Status</th>
            <th class="px-6 py-3 font-semibold">Usage Duration</th>
            <th class="px-6 py-3 font-semibold text-center">Actions</th>
          </tr>
        </thead>
        <tbody class="bg-white/10">
          {% for a in appliances %}
          <tr class="border-b border-green-700/50 even:bg-green-900/20 hover:bg-green-900/40 transition">
            <td class="px-6 py-3 whitespace-nowrap">
                <div class="font-semibold text-lg text-white">{{ a['name'] }}</div>
            </td>
            <td class="px-6 py-3 whitespace-nowrap text-gray-300">{{ a['count'] }}</td>
            <td class="px-6 py-3 whitespace-nowrap text-gray-300">{{ a['watts'] }} W</td>
            <td class="px-6 py-3 text-center">
              <form method="post" class="inline-flex items-center" onsubmit="return validateUnitsOn(this, {{ a['count'] }}, {{ a['is_on']|int }});">
                <input type="hidden" name="toggle_id" value="{{ a['id'] }}">
                <input type="number" name="units_on" min="1" max="{{ a['count'] }}" value="{{ a['units_on'] if a['is_on'] and a['units_on'] else a['count'] }}" class="w-20 px-2 py-1.5 rounded-l-md bg-gray-800/70 border border-green-500 text-white mr-0 focus:outline-none focus:ring-1 focus:ring-green-400" title="How many units to turn on?" {% if a['is_on'] %}disabled{% endif %}>
                <button type="submit" class="px-4 py-1.5 rounded-r-md font-semibold transition {{ 'bg-green-500 text-white' if a['is_on'] else 'bg-gray-600 text-gray-300' }} hover:bg-green-600">
                  {{ 'On' if a['is_on'] else 'Off' }}
                </button>
              </form>
            </td>
            <td class="px-6 py-3 whitespace-nowrap">
              {% if a['is_on'] and a['last_on_time'] %}
                <span class="live-timer font-semibold text-yellow-400 text-lg" data-start-time="{{ a['last_on_time'] }}">...</span>
              {% else %}
                <span class="text-gray-500">-</span>
              {% endif %}
            </td>
            <td class="px-6 py-3 text-center">
              <form method="post" class="inline-block" onsubmit="return confirm('Are you sure you want to remove this appliance?');">
                <input type="hidden" name="remove_id" value="{{ a['id'] }}">
                <button type="submit" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold transition">Remove</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <script>
        function validateUnitsOn(form, maxCount, isOn) {
          if (isOn === 0) { // Only validate when turning on
            var units = form.units_on.value;
            if (units < 1 || units > maxCount) {
              alert('Please enter a valid number of units (1 to ' + maxCount + ').');
              return false;
            }
          }
          return true;
        }
      </script>
      {% if not appliances %}
        <div class="text-center text-gray-400 py-16">
            <h3 class="text-xl">No appliances found.</h3>
            <p class="text-gray-500">Try adding one using the form above.</p>
        </div>
      {% endif %}
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const timers = document.querySelectorAll('.live-timer');
        
        function updateTimers() {
          timers.forEach(timer => {
            const startTime = new Date(timer.dataset.startTime).getTime();
            if (isNaN(startTime)) {
              timer.textContent = '...';
              return;
            }
            
            const now = new Date().getTime();
            const diff = now - startTime;
            
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            let durationString = '';
            if (hours > 0) {
              durationString += `${hours}h `;
            }
            if (minutes > 0 || hours > 0) {
              durationString += `${minutes}m `;
            }
            durationString += `${seconds}s`;
            
            timer.textContent = durationString;
          });
        }
        
        if (timers.length > 0) {
          updateTimers();
          setInterval(updateTimers, 1000);
        }
      });
    </script>
{% endblock %}
  </div>
</body>
</html>